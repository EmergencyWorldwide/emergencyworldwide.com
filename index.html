<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>911 Dial Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .container-fluid {
            height: 100%;
            padding: 15px;
        }
        .row {
            height: calc(100% - 30px);
        }
        #map {
            height: 100%;
            min-height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .building-panel {
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .building-icon {
            text-align: center;
            background: white;
            border-radius: 50%;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .mission-icon {
            text-align: center;
            background: white;
            border-radius: 50%;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: pulse 1s infinite;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .police-station {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        .fire-station {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        .hospital {
            background: #2ecc71;
            color: white;
            border-color: #27ae60;
        }
        .mission-crime {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        .mission-fire {
            background: #f39c12;
            color: white;
            border-color: #d35400;
        }
        .mission-medical {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.5;
        }
        .leaflet-popup-content button {
            margin-top: 8px;
            width: 100%;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .alert {
            margin-bottom: 15px;
            border-radius: 8px;
        }
        .accordion {
            border-radius: 8px;
            overflow: hidden;
        }
        .accordion-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .accordion-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mt-3">
            <div class="col-md-9">
                <div id="map"></div>
            </div>
            <div class="col-md-3">
                <div class="building-panel">
                    <h3>Emergency Services</h3>
                    <div class="alert alert-info">
                        Budget: $<span id="budget">10000000</span>
                    </div>
                    <div class="alert alert-warning">
                        Active Missions: <span id="mission-count">0</span>
                    </div>
                    <div class="accordion" id="buildingAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#policePanel">
                                    Police Stations
                                </button>
                            </h2>
                            <div id="policePanel" class="accordion-collapse collapse show">
                                <div class="accordion-body">
                                    <button class="btn btn-primary mb-2" onclick="addBuilding('police_station', 500000)">
                                        Add Police Station ($500,000)
                                    </button>
                                    <button class="btn btn-secondary mb-2" onclick="addVehicle('police_car', 50000)">
                                        Add Police Car ($50,000)
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#firePanel">
                                    Fire Stations
                                </button>
                            </h2>
                            <div id="firePanel" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <button class="btn btn-danger mb-2" onclick="addBuilding('fire_station', 750000)">
                                        Add Fire Station ($750,000)
                                    </button>
                                    <button class="btn btn-secondary mb-2" onclick="addVehicle('fire_truck', 100000)">
                                        Add Fire Truck ($100,000)
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hospitalPanel">
                                    Hospitals
                                </button>
                            </h2>
                            <div id="hospitalPanel" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <button class="btn btn-success mb-2" onclick="addBuilding('hospital', 1000000)">
                                        Add Hospital ($1,000,000)
                                    </button>
                                    <button class="btn btn-secondary mb-2" onclick="addVehicle('ambulance', 75000)">
                                        Add Ambulance ($75,000)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>
    <script>
        let buildings = [];
        let vehicles = [];
        let missions = new Map();
        let selectedBuilding = null;
        let placementMode = false;
        let budget = 10000000;
        let missionMarkers = new Map();
        let map;

        // Initialize the map
        function initMap() {
            map = L.map('map', {
                center: [40.7128, -74.0060],  // New York, USA
                zoom: 12,
                fullscreenControl: true,
                zoomControl: true
            });

            // Add OpenStreetMap tiles with proper attribution
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add map controls
            L.control.scale().addTo(map);
            L.control.locate({
                position: 'topleft',
                strings: {
                    title: "Show my location"
                },
                locateOptions: {
                    enableHighAccuracy: true
                }
            }).addTo(map);
        }

        // Socket.IO setup
        const socket = io();
        
        socket.on('new_mission', (mission) => {
            addMissionToMap(mission);
            updateMissionCount();
        });

        socket.on('mission_expired', (data) => {
            if (missionMarkers.has(data.id)) {
                map.removeLayer(missionMarkers.get(data.id));
                missionMarkers.delete(data.id);
                updateMissionCount();
            }
        });

        function updateMissionCount() {
            document.getElementById('mission-count').textContent = missionMarkers.size;
        }

        function getIconHtml(type) {
            const icons = {
                'police_station': 'üëÆ',
                'fire_station': 'üöí',
                'hospital': 'üè•'
            };
            const cssClass = type.replace('_', '-');
            return `<div class="building-icon ${cssClass}">${icons[type]}</div>`;
        }

        function getMissionIcon(type) {
            const icons = {
                'crime': 'üöî',
                'fire': 'üî•',
                'medical': 'üöë'
            };
            return icons[type] || '‚ùó';
        }

        function addBuilding(type, cost) {
            if (!updateBudget(-cost)) {
                alert('Not enough budget to build this!');
                return;
            }

            if (placementMode) {
                alert('Already placing a building. Click on the map to place it.');
                updateBudget(cost); // Refund the cost
                return;
            }

            placementMode = true;
            const buildingNames = {
                'police_station': 'Police Station',
                'fire_station': 'Fire Station',
                'hospital': 'Hospital'
            };

            map.once('click', async (e) => {
                const response = await fetch('/api/buildings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `${buildingNames[type]} ${buildings.length + 1}`,
                        type: type,
                        lat: e.latlng.lat,
                        lon: e.latlng.lng,
                        cost: cost
                    })
                });

                const result = await response.json();
                if (result.success) {
                    await loadData();
                } else {
                    updateBudget(cost); // Refund if failed
                    alert('Failed to place building. Please try again.');
                }
                placementMode = false;
            });

            // Allow canceling placement with right click
            const cancelPlacement = () => {
                if (placementMode) {
                    placementMode = false;
                    updateBudget(cost); // Refund the cost
                    map.off('contextmenu', cancelPlacement);
                }
            };
            map.on('contextmenu', cancelPlacement);
        }

        function addVehicle(type, cost) {
            if (!updateBudget(-cost)) {
                alert('Not enough budget to purchase this vehicle!');
                return;
            }

            if (!selectedBuilding) {
                updateBudget(cost); // Refund if no building selected
                alert('Please select a building first by clicking on it!');
                return;
            }

            // Find the selected building
            const building = buildings.find(b => b.id === selectedBuilding);
            if (!building) {
                updateBudget(cost); // Refund if building not found
                alert('Selected building not found!');
                return;
            }

            // Check if vehicle type matches building type
            const validCombos = {
                'police_station': ['police_car'],
                'fire_station': ['fire_truck'],
                'hospital': ['ambulance']
            };

            if (!validCombos[building.type].includes(type)) {
                updateBudget(cost); // Refund if invalid combination
                alert(`Cannot add ${type.replace('_', ' ')} to ${building.type.replace('_', ' ')}!`);
                return;
            }

            fetch('/api/vehicles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: `${type.replace('_', ' ')} ${vehicles.length + 1}`,
                    type: type,
                    building_id: selectedBuilding,
                    cost: cost
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loadData();
                } else {
                    updateBudget(cost); // Refund if failed
                }
            });
        }

        function deleteBuilding(buildingId, cost) {
            if (confirm('Are you sure you want to sell this building and all its vehicles? You will receive a 50% refund for the building and 70% for vehicles.')) {
                fetch(`/api/buildings/${buildingId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        updateBudget(result.refund);
                        loadData();
                    }
                });
            }
        }

        function deleteVehicle(vehicleId, cost) {
            if (confirm('Are you sure you want to sell this vehicle? You will receive a 70% refund.')) {
                fetch(`/api/vehicles/${vehicleId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        updateBudget(result.refund);
                        loadData();
                    }
                });
            }
        }

        function addMissionToMap(mission) {
            // Remove existing mission if any
            if (missionMarkers.has(mission.id)) {
                map.removeLayer(missionMarkers.get(mission.id));
            }

            const icon = L.divIcon({
                className: '',
                html: `<div class="mission-icon mission-${mission.type}">${getMissionIcon(mission.type)}</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });

            const expiresAt = new Date(mission.expires_at);
            const now = new Date();
            const timeLeft = Math.max(0, Math.floor((expiresAt - now) / 1000));

            const marker = L.marker([mission.lat, mission.lon], { icon })
                .addTo(map)
                .bindPopup(`
                    <strong>${mission.description}</strong><br>
                    Reward: $${mission.reward.toLocaleString()}<br>
                    Time Left: <span class="mission-timer-${mission.id}">${timeLeft}</span> seconds<br>
                    <button class="btn btn-success btn-sm mt-2" onclick="completeMission(${mission.id})">
                        Complete Mission
                    </button>
                `);

            missionMarkers.set(mission.id, marker);
            updateMissionCount();

            // Set up countdown timer
            if (timeLeft > 0) {
                const timerId = setInterval(() => {
                    const timeElement = document.querySelector(`.mission-timer-${mission.id}`);
                    if (timeElement) {
                        const currentTime = parseInt(timeElement.textContent);
                        if (currentTime > 0) {
                            timeElement.textContent = currentTime - 1;
                        } else {
                            clearInterval(timerId);
                            if (missionMarkers.has(mission.id)) {
                                map.removeLayer(missionMarkers.get(mission.id));
                                missionMarkers.delete(mission.id);
                                updateMissionCount();
                            }
                        }
                    } else {
                        clearInterval(timerId);
                    }
                }, 1000);
            }
        }

        function completeMission(missionId) {
            fetch(`/api/missions/${missionId}/complete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    updateBudget(result.reward);
                    if (missionMarkers.has(missionId)) {
                        map.removeLayer(missionMarkers.get(missionId));
                        missionMarkers.delete(missionId);
                        updateMissionCount();
                    }
                }
            })
            .catch(error => {
                console.error('Error completing mission:', error);
                alert('Failed to complete mission. Please try again.');
            });
        }

        function updateBudget(amount) {
            budget += amount;
            document.getElementById('budget').textContent = budget.toLocaleString();
            return budget >= 0;
        }

        // Load existing buildings and vehicles
        async function loadData() {
            const buildingResponse = await fetch('/api/buildings');
            buildings = await buildingResponse.json();
            
            const vehicleResponse = await fetch('/api/vehicles');
            vehicles = await vehicleResponse.json();
            
            updateMap();
        }

        function updateMap() {
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            buildings.forEach(building => {
                const icon = L.divIcon({
                    className: '',
                    html: getIconHtml(building.type),
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    popupAnchor: [0, -20]
                });

                const vehiclesList = vehicles.filter(v => v.building_id === building.id);
                const vehicleListHtml = vehiclesList.length > 0 
                    ? '<hr>Vehicles:<br>' + vehiclesList.map(v => 
                        `${v.name} <button class="btn btn-danger btn-sm" onclick="deleteVehicle(${v.id}, ${v.cost})">Sell</button>`
                    ).join('<br>')
                    : '';

                L.marker([building.lat, building.lon], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>${building.name}</strong><br>
                        Type: ${building.type.replace('_', ' ')}<br>
                        Vehicles: ${vehiclesList.length}<br>
                        <button class="btn btn-danger btn-sm mt-2" onclick="deleteBuilding(${building.id}, ${building.cost})">Sell Building</button>
                        ${vehicleListHtml}
                    `)
                    .on('click', () => {
                        selectedBuilding = building.id;
                        buildings.forEach(b => {
                            map.eachLayer((layer) => {
                                if (layer instanceof L.Marker) {
                                    if (b.id === selectedBuilding) {
                                        layer.setOpacity(1);
                                        layer.openPopup();
                                    } else {
                                        layer.setOpacity(0.6);
                                    }
                                }
                            });
                        });
                    });
            });
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();
            loadMissions();
        });

        function loadMissions() {
            fetch('/api/missions')
                .then(response => response.json())
                .then(missions => {
                    missions.forEach(addMissionToMap);
                });
        }
    </script>
</body>
</html>
